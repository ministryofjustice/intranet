limit_req_zone $binary_remote_addr zone=flood:15m rate=5r/s;

map $http_x_forwarded_proto $real_scheme {
  default $http_x_forwarded_proto;
  ''      $scheme;
}

fastcgi_cache_path /var/run/nginx-cache levels=1:2 keys_zone=pub01:100m inactive=60m;
fastcgi_cache_use_stale updating error timeout invalid_header http_500;
fastcgi_cache_key "$real_scheme$request_method$host$request_uri";

# Make the logs easier to search in cloudwatch
log_format json_combined escape=json '{ "time_local": "$time_iso8601", '
 '"remote_addr": "$remote_addr", '
 '"remote_user": "$remote_user", '
 '"request": "$request", '
 '"status": "$status", '
 '"body_bytes_sent": "$body_bytes_sent", '
 '"request_time": "$request_time", '
 '"http_referrer": "$http_referer", '
 '"http_user_agent": "$http_user_agent" }';

# Simple workaround for images broked by missing CORS headers.
server {
    server_name www.intranet.justice.gov.uk;
    return 301 $scheme://intranet.justice.gov.uk$request_uri;
}

server {
  listen 80 default_server;
  error_page 403 /403.html;
  location /403.html {
    allow all;
  }

  access_log /var/log/nginx/access.log json_combined;

  root /bedrock/web;
  index index.php;

  client_max_body_size 250m;

  include /etc/nginx/real_ip.conf;

  if ($http_x_forwarded_proto = "https") {
    set $use_ssl "on";
  }

  if ( $http_x_forwarded_proto = "http" ) {
    return 301 https://$host$request_uri;
  }

  location /wp-content/uploads/ {
    rewrite ^/wp-content/uploads/(.*)$ /app/uploads/$1 permanent;
  }

# Without the prefix matching (`^~`) this does not reliably match paths with
# filenames. `location /wp-admin {...` will match `\wp-admin`, but not
# `\wp-admin\post-new.php`, for example.
  location ^~ /wp-admin {
    rewrite /(.*)$ /wp/$1 permanent;
  }

  set $skip_cache 0;

  if ($request_method = POST) {
    set $skip_cache 1;
  }

  if ($query_string != "") {
    set $skip_cache 1;
  }

  if ($request_uri ~* "/wp-admin/|/xmlrpc.php|wp-.*.php|/feed/|index.php|sitemap(_index)?.xml") {
    set $skip_cache 1;
  }

  if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
    set $skip_cache 1;
  }

  location / {
    try_files $uri $uri/ /index.php?$args;
  }

  server_tokens off;

  include /etc/nginx/whitelists/site-wide.conf;

  location ~ /\. {
    deny all;
  }

  location ~* /(?:uploads|files)/.*\.php$ {
    deny all;
  }

  location ~ \.php$ {
    include /etc/nginx/php-fpm.conf;
  }

  location = /wp/wp-login.php {
    limit_req zone=flood burst=5 nodelay;

    include /etc/nginx/whitelists/wp-login.conf;
    include /etc/nginx/php-fpm.conf;
  }

  location ~ /purge-cache(/.*) {
    fastcgi_cache_purge pub01 "$real_scheme$request_method$host$1";
  }

  location = /robots.txt { access_log off; log_not_found off; }

  location ~* \.(?:css|js|ico|woff|eot|svg|ttf|otf|png|gif|jpe?g) {
    access_log off;
    add_header Cache-Control public;
    expires 1d;
  }

  gzip on;
  gzip_disable "msie6";

  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_buffers 16 8k;
  gzip_http_version 1.1;
  gzip_types text/plain text/css application/json application/x-javascript application/javascript text/xml application/xml application/xml+rss text/javascript;
}
