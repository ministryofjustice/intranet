apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: intranet-staging
  namespace: intranet-staging
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: intranet-staging
  minReplicas: 3
  maxReplicas: 12
  metrics:
    # fpm
    - type: ContainerResource
      containerResource:
        name: cpu
        container: fpm
        target:
          type: Utilization
          # If request is 500m let's early scale at 250m
          averageUtilization: 50
    - type: ContainerResource
      containerResource:
        name: memory
        container: fpm
        target:
          type: Utilization
          # If request is 600Mi and php max is 384Mi let's scale at 420Mi
          averageUtilization: 70
    # nginx
    - type: ContainerResource
      containerResource:
        name: cpu
        container: nginx
        target:
          type: Utilization
          averageUtilization: 70
    - type: ContainerResource
      containerResource:
        name: memory
        container: nginx
        target:
          type: Utilization
          averageUtilization: 70
